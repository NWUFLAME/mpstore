'use strict';var _extends=Object.assign||function(a){for(var c,b=1;b<arguments.length;b++)for(var d in c=arguments[b],c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d]);return a},_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};Object.defineProperty(exports,'__esModule',{value:!0});function obaa(a,b,c){var d=function _observe(f,g,h){var j=this,k=[];for(var l in obaa.isArray(f)&&(0===f.length&&j.track(f),j.mock(f)),f&&'object'===('undefined'==typeof f?'undefined':_typeof(f))&&0===Object.keys(f).length&&j.track(f),f)f.hasOwnProperty(l)&&(h?obaa.isArray(g)&&obaa.isInArray(g,l)?(k.push(l),j.watch(f,l)):obaa.isString(g)&&l==g&&(k.push(l),j.watch(f,l)):(k.push(l),j.watch(f,l)));j.target=f,j.propertyChangedHandler||(j.propertyChangedHandler=[]);var m=h?h:g;j.propertyChangedHandler.push({all:!h,propChanged:m,eventPropArr:k})};return d.prototype={onPropertyChanged:function onPropertyChanged(f,g,h,j,k){if(g!==h&&!(nan(g)&&nan(h))&&this.propertyChangedHandler)for(var o,l=obaa._getRootName(f,k),m=0,n=this.propertyChangedHandler.length;m<n;m++)o=this.propertyChangedHandler[m],(o.all||obaa.isInArray(o.eventPropArr,l)||0===l.indexOf('Array-'))&&o.propChanged.call(this.target,f,g,h,k);0!==f.indexOf('Array-')&&'object'===('undefined'==typeof g?'undefined':_typeof(g))&&this.watch(j,f,j.$observeProps.$observerPath)},mock:function mock(f){var g=this;obaa.methods.forEach(function(h){f[h]=function(){var j=this,k=Array.prototype.slice.call(this,0),l=Array.prototype[h].apply(this,Array.prototype.slice.call(arguments));return new RegExp('\\b'+h+'\\b').test(obaa.triggerStr)&&(Object.keys(this).forEach(function(m){obaa.isFunction(j[m])||g.watch(j,m,j.$observeProps.$observerPath)}),g.onPropertyChanged('Array-'+h,this,k,this,this.$observeProps.$observerPath)),l},f['pure'+h.substring(0,1).toUpperCase()+h.substring(1)]=function(){return Array.prototype[h].apply(this,Array.prototype.slice.call(arguments))}})},watch:function watch(f,g,h){var j=this;if('$observeProps'!==g&&'$observer'!==g&&!obaa.isFunction(f[g])){f.$observeProps||Object.defineProperty(f,'$observeProps',{configurable:!0,enumerable:!1,writable:!0,value:{}}),f.$observeProps.$observerPath=void 0===h?'#':h;var k=this,l=f.$observeProps[g]=f[g];Object.defineProperty(f,g,{configurable:!0,get:function get(){return this.$observeProps[g]},set:function set(m){var n=this.$observeProps[g];this.$observeProps[g]=m,k.onPropertyChanged(g,m,n,this,f.$observeProps.$observerPath)}}),'object'==('undefined'==typeof l?'undefined':_typeof(l))&&null!==l&&(obaa.isArray(l)&&(this.mock(l),0===l.length&&this.track(l,g,h)),l&&0===Object.keys(l).length&&this.track(l,g,h),Object.keys(l).forEach(function(m){j.watch(l,m,f.$observeProps.$observerPath+'-'+g)}))}},track:function track(f,g,h){f.$observeProps||(Object.defineProperty(f,'$observeProps',{configurable:!0,enumerable:!1,writable:!0,value:{}}),f.$observeProps.$observerPath=void 0!==h&&null!==h?h+'-'+g:void 0!==g&&null!==g?'#-'+g:'#')}},new d(a,b,c)}obaa.methods=['concat','copyWithin','entries','every','fill','filter','find','findIndex','forEach','includes','indexOf','join','keys','lastIndexOf','map','pop','push','reduce','reduceRight','reverse','shift','slice','some','sort','splice','toLocaleString','toString','unshift','values','size'],obaa.triggerStr=['concat','copyWithin','fill','pop','push','reverse','shift','sort','splice','unshift','size'].join(','),obaa.isArray=function(a){return'[object Array]'===Object.prototype.toString.call(a)},obaa.isString=function(a){return'string'==typeof a},obaa.isInArray=function(a,b){for(var c=a.length;-1<--c;)if(b===a[c])return!0;return!1},obaa.isFunction=function(a){return'[object Function]'==Object.prototype.toString.call(a)},obaa._getRootName=function(a,b){return'#'===b?a:b.split('-')[1]},obaa.add=function(a,b){var c=a.$observer;c.watch(a,b)},obaa.set=function(a,b,c,d){if(a[b]===void 0){var f=a.$observer||d;f.watch(a,b,a.$observeProps.$observerPath)}a[b]=c},Array.prototype.size=function(a){this.length=a};function nan(a){return'number'==typeof a&&isNaN(a)}var OBJECTTYPE='[object Object]',ARRAYTYPE='[object Array]';function getUsing(a,b){if(!b)return{};var c={};return b.forEach(function(d){if(!('string'==typeof d)){var h=Object.keys(d)[0],j=d[h];if('string'!=typeof j){var k=j[0];if('string'==typeof k){var l=getTargetByPath(a,k);c[h]=j[1]?j[1](l):l}else{var l=[];k.forEach(function(m){l.push(getTargetByPath(a,m))}),c[h]=j[1].apply(null,l)}}}}),c}function getTargetByPath(a,b){for(var c=b.replace(/]/g,'').replace(/\[/g,'.').split('.'),d=a,f=0,g=c.length;f<g;f++)d=d[c[f]];return d}function getPath(a){if(Array.isArray(a)){var b={};return a.forEach(function(c){if('string'==typeof c)b[c]=!0;else{var d=c[Object.keys(c)[0]];'string'==typeof d?b[d]=!0:'string'==typeof d[0]?b[d[0]]=!0:d[0].forEach(function(f){return b[f]=!0})}}),b}return getUpdatePath(a)}function getUpdatePath(a){var b={};return dataToPath(a,b),b}function dataToPath(a,b){Object.keys(a).forEach(function(c){b[c]=!0;var d=Object.prototype.toString.call(a[c]);d===OBJECTTYPE?_objToPath(a[c],c,b):d===ARRAYTYPE&&_arrayToPath(a[c],c,b)})}function _objToPath(a,b,c){Object.keys(a).forEach(function(d){c[b+'.'+d]=!0,delete c[b];var f=Object.prototype.toString.call(a[d]);f===OBJECTTYPE?_objToPath(a[d],b+'.'+d,c):f===ARRAYTYPE&&_arrayToPath(a[d],b+'.'+d,c)})}function _arrayToPath(a,b,c){a.forEach(function(d,f){c[b+'['+f+']']=!0,delete c[b];var g=Object.prototype.toString.call(d);g===OBJECTTYPE?_objToPath(d,b+'['+f+']',c):g===ARRAYTYPE&&_arrayToPath(d,b+'['+f+']',c)})}function needUpdate(a,b){for(var c in a){if(b[c])return!0;for(var d in b)if(includePath(c,d))return!0}return!1}function includePath(a,b){if(0===a.indexOf(b)){var c=a.substr(b.length,1);if('['===c||'.'===c)return!0}return!1}function fixPath(a){var b='',c=a.replace('#-','').split('-');return c.forEach(function(d,f){b+=f?isNaN(+d)?'.'+d:'['+d+']':d}),b}var globalStore=null,gettersWM=new WeakMap,storeToIns=new WeakMap;function mpstore(a,b,c){if(c){b.getters=a.getters,gettersWM.set(a,{}),a.instances||(a.instances={}),a.__changes_||(a.__changes_=[]),a.mutations=a.mutations||{},b.commit=function(g,h){a.mutations[g](a.state,h)},a.actions=a.actions||{},b.dispatch=function(g,h){a.actions[g]({state:a.state,globalState:a.state,dispatch:b.dispatch,dispatchGlobal:b.dispatch,commit:b.commit,commitGlobal:b.commit,getters:gettersWM.get(globalStore),globalGetters:gettersWM.get(globalStore)},h)};var d=a.__changes_;a.onChange||(a.onChange=function(g){d.push(g)}),a.offChange||(a.offChange=function(g){for(var h=0,j=d.length;h<j;h++)if(d[h]===g){d.splice(h,1);break}}),a.gettersProxyObj={},Object.keys(a.getters||{}).forEach(function(g){Object.defineProperty(a.gettersProxyObj,g,{enumerable:!0,get:function get(){return a.getters[g]({globalState:globalStore.state,state:globalStore.state,getters:a.gettersProxyObj,globalGetters:a.gettersProxyObj})},set:function set(){throw new Error('Illegal operation, getters are readonly.')}})}),b.globalData=b.globalData||{},Object.assign(b.globalData,b.state),observeStore(a,!0);var f=b.onLaunch;b.onLaunch=function(g){this.store=a,globalStore=a,Object.defineProperty(this,'state',{enumerable:!0,get:function get(){return this.store.state},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}}),Object.defineProperty(this,'getters',{enumerable:!0,get:function get(){var j=gettersWM.get(globalStore);return j},set:function set(){throw new Error('getters are readonly')}}),b.use&&(this.__updatePath=getPath(b.use)),this.__use=b.use;var h=getUsing(a.state,b.use);b.getters&&compute(b.getters,a,h,this),f&&f.call(this,g)},App(b)}else if(2===arguments.length){b.__initStateSnapShot__=JSON.stringify(a.state),gettersWM.set(a,{}),globalStore.instances||(globalStore.instances={}),a.__changes_||(a.__changes_=[]),a.mutations=a.mutations||{},b.getters=a.getters,a.gettersProxyObj={},Object.keys(a.getters||{}).forEach(function(h){Object.defineProperty(a.gettersProxyObj,h,{enumerable:!0,get:function get(){return a.getters[h]({globalState:globalStore.state,state:a===globalStore?globalStore.state:a.state,getters:a.gettersProxyObj,globalGetters:globalStore.gettersProxyObj})},set:function set(){throw new Error('Illegal operation, getters are readonly.')}})}),b.commitGlobal=function(h,j){globalStore.mutations[h](globalStore.state,j)},b.commit=function(h,j){a.mutations[h](a.state,j)},a.actions=a.actions||{},b.dispatchGlobal=function(h,j){globalStore.actions[h]({state:globalStore.state,globalState:globalStore.state,dispatch:b.dispatchGlobal,dispatchGlobal:b.dispatchGlobal,commit:b.commitGlobal,commitGlobal:b.commitGlobal,getters:gettersWM.get(globalStore),globalGetters:gettersWM.get(globalStore)},j)},b.dispatch=function(h,j){a.actions[h]({state:a.state,globalState:globalStore.state,dispatch:b.dispatch,dispatchGlobal:b.dispatchGlobal,commit:b.commit,commitGlobal:b.commitGlobal,getters:gettersWM.get(a),globalGetters:gettersWM.get(globalStore)},j)};var d=a.__changes_;a.onChange||(a.onChange=function(h){d.push(h)}),a.offChange||(a.offChange=function(h){for(var j=0,k=d.length;j<k;j++)if(d[j]===h){d.splice(j,1);break}}),b.data=b.data||{},Object.assign(b.data,a.state),b.data.$globalState=globalStore.state,b.data.$globalGetters=gettersWM.get(globalStore),observeStore(a);var f=b.onLoad,g=b.onUnload;b.onLoad=function(h){storeToIns.set(a,this),this.store=a,Object.defineProperty(this,'state',{enumerable:!0,get:function get(){var k=this.store.state;return k},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}}),Object.defineProperty(this,'globalState',{enumerable:!0,get:function get(){var k=globalStore.state;return k},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}}),Object.defineProperty(this,'getters',{enumerable:!0,get:function get(){var k=gettersWM.get(this.store);return k},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}}),Object.defineProperty(this,'globalGetters',{enumerable:!0,get:function get(){var k=gettersWM.get(globalStore);return k},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}}),b.use&&(this.__updatePath=getPath(b.use)),this.__use=b.use,globalStore.instances[this.route]=globalStore.instances[this.route]||[],globalStore.instances[this.route].push(this),this.setData(b.data);var j=getUsing(a.state,b.use);b.getters&&compute(b.getters,a,j,this),this.setData(j),f&&f.call(this,h)},b.onUnload=function(h){var j=this,k=JSON.parse(this.__initStateSnapShot__);Object.keys(k).forEach(function(l){a.state[l]=k[l]}),this.setData(_extends({},k)),globalStore.instances[this.route]=globalStore.instances[this.route].filter(function(l){return l!==j}),g&&g.call(this,h)},Page(b)}else{a.lifetimes=a.lifetimes||{};var d=a.lifetimes.ready||a.ready;a.ready=a.lifetimes.ready=function(){var f=getCurrentPages()[getCurrentPages().length-1];a.use&&(this.__updatePath=getPath(a.use)),this.store=f.store,this.__use=a.use,this.getters=a.getters,a.state=this.store.state,this.setData(a.state);var g=getUsing(this.store.state,a.use);a.getters&&compute(a.getters,this.store,g,this),this.setData(g),f._omixComponents=f._omixComponents||[],f._omixComponents.push(this),d&&d.call(this)},Component(a)}}mpstore.Page=function(a,b){mpstore(a,b)},mpstore.App=function(a,b){mpstore(a,b,!0)},mpstore.Component=function(a,b){if(2===arguments.length){globalStore.instances||(globalStore.instances={}),a.__changes_||(a.__changes_=[]);var c=a.__changes_;a.onChange||(a.onChange=function(k){c.push(k)}),a.offChange||(a.offChange=function(k){for(var l=0,m=c.length;l<m;l++)if(c[l]===k){c.splice(l,1);break}});var d='undefined'!=typeof b.data,f;b.data?(f=JSON.parse(JSON.stringify(b.data)),b.data.$=a.state):b.data=a.state,observeStore(a);var g=b.detached;b.lifetimes=b.lifetimes||{};var h=b.lifetimes.created||b.created,j=b.lifetimes.ready||b.ready;b.created=b.lifetimes.created=function(k){this.store=a,b.use&&(this.__updatePath=getPath(b.use)),this.__use=b.use,this.__hasData=d,d&&Object.assign(b.data,JSON.parse(JSON.stringify(f))),h&&h.call(this,k)},b.ready=b.lifetimes.ready=function(k){var l=this.store;globalStore.instances[this.is]=globalStore.instances[this.is]||[],globalStore.instances[this.is].push(this),this.getters=b.getters,this.setData(b.data);var m=getUsing(l.state,b.use);console.log('333',m),b.getters&&compute(b.getters,l,m,this),this.setData(m),j&&j.call(this,k)},b.lifetimes.detached=b.detached=function(k){var l=this;globalStore.instances[this.is]=(globalStore.instances[this.is]||[]).filter(function(m){return m!==l}),g&&g.call(this,k)},Component(b)}else{a.lifetimes=a.lifetimes||{};var c=a.lifetimes.ready||a.ready;a.ready=a.lifetimes.ready=function(){var d=getCurrentPages()[getCurrentPages().length-1];a.use&&(this.__updatePath=getPath(a.use)),this.store=d.store,this.__use=a.use,this.getters=a.getters,a.state=this.store.state,this.setData(a.state);var f=getUsing(this.store.state,a.use);console.log('444',f),a.getters&&compute(a.getters,this.store,f,this),this.setData(f),d._omixComponents=d._omixComponents||[],d._omixComponents.push(this),c&&c.call(this)},Component(a)}};function compute(a,b,c){var f=gettersWM.get(b);for(var g in a)f[g]=c[g]=a[g]({globalState:globalStore.state,state:b.state,getters:b.gettersProxyObj,globalGetters:globalStore.gettersProxyObj})}function observeStore(a,b){var c=obaa(a.state,function(f,g,h,j){var k={};if(0===f.indexOf('Array-push'))for(var l=g.length-h.length,m=0;m<l;m++)k[fixPath(j+'-'+(h.length+m))]=g[h.length+m];else 0===f.indexOf('Array-')?k[fixPath(j)]=g:k[fixPath(j+'-'+f)]=g;_update(k,a,b)});a.set||(a.set=function(f,g,h){obaa.set(f,g,h,c)});var d=a.state;Object.defineProperty(a,'state',{enumerable:!0,get:function get(){return d},set:function set(){throw new Error('You must not replace store.state directly, instead assign nest prop')}})}function _update(a,b,c){if(c)for(var d in globalStore.instances)globalStore.instances[d].forEach(function(f){_updateOne(a,b,f,c),f._omixComponents&&f._omixComponents.forEach(function(g){_updateOne(a,b,g,c)})});else{var d=storeToIns.get(b);_updateOne(a,b,d,c)}b.__changes_.forEach(function(d){d(a)}),b.logger&&storeChangeLogger(b,a)}function _updateOne(a,b,c,d){return d?void(!(b.updateAll||c.__updatePath&&needUpdate(a,c.__updatePath))||_updateImpl(a,b,c,d)):_updateImpl(a,b,c,d)}function _updateImpl(a,b,c,d){return wx.nextTick?void(c._omixDataBuffer===void 0&&(c._omixDataBuffer={}),Object.assign(c._omixDataBuffer,a),!c._omixTickScheduled&&(wx.nextTick(function(){_doUpdate(c._omixDataBuffer,b,c,d),c._omixDataBuffer={},c._omixTickScheduled=!1}),c._omixTickScheduled=!0)):_doUpdate(a,b,c,d)}function _doUpdate(a,b,c,d){if(0!==Object.keys(a).length){if(d)for(var g in a)a['$globalState.'+g]=a[g],delete a[g];c&&c.setData&&c.setData.call(c,a);var f=getUsing(b.state,c.__use);if(c.getters&&compute(b.getters,b,f,c),d)for(var g in c.getters&&compute(c.store.getters,c.store,f,c),f)-1<Object.keys(globalStore.getters||{}).indexOf(g)&&(f['$globalGetters.'+g]=f[g],delete f[g]);c&&c.setData&&c.setData.call(c,f)}}function storeChangeLogger(a,b){try{var c=wx.getStorageSync('CurrentState')||{};console.groupCollapsed('%c  '+'Data Changed'+' %c '+Object.keys(b),'color:#e0c184; font-weight: bold','color:#f0a139; font-weight: bold'),console.log('%c    Pre Data','color:#ff65af; font-weight: bold',c),console.log('%c Change Data','color:#3d91cf; font-weight: bold',b),console.log('%c   Next Data','color:#2c9f67; font-weight: bold',a.state),console.groupEnd(),wx.setStorageSync('CurrentState',a.state)}catch(c){console.log(c)}}mpstore.obaa=obaa,exports.default=mpstore;